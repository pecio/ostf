---
- name: Install Harbor
  hosts:
    - harbor
  become: False
  gather_facts: True
  gather_subset:
    - '!all'
    - interfaces
  roles:
    - name: harbor

- name: Create Kubernetes cluster
  hosts:
    - k8s
  become: False
  gather_facts: False
  roles:
    - name: k8s
      pod_network_cidr: 172.20.0.0/16

- name: OpenStack integration
  hosts:
    - node0
  become: False
  gather_facts: False
  pre_tasks:
    # https://stackoverflow.com/a/76382917
    - name: Wait until load is below 5.0
      ansible.builtin.command: cat /proc/loadavg
      register: cpu_load
      until: cpu_load.stdout.split()|first|float < 5.0
      retries: 120
      delay: 5
  roles:
    - name: geerlingguy.helm
      become: True
    - name: k8s_openstack
